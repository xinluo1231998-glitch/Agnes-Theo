<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>èƒ–æ¬£æ¬£ & ç˜¦åª›åª›çš„ä¸“å±æƒ…äººèŠ‚</title>
  <meta name="description" content="æç®€è«å…°è¿ªé£ï¼šç‚¹èœ + å¿ƒæ„¿ + ç¡®è®¤ä¸‹å•ï¼ˆæœ¬åœ°ä¿å­˜ + é«˜æ¸…å›¾ IndexedDB + Formspree é‚®ä»¶é€šçŸ¥ï¼‰" />
  <style>
    :root{
      --bg:#F6F3EE; --card:#FFFFFF; --ink:#1F2328; --muted:#6D7179; --line:rgba(31,35,40,.10);
      --pink:#C7A5A9; --sage:#AEB9AD; --slate:#8D97A1; --clay:#C8B3A4;
      --shadow:0 14px 36px rgba(31,35,40,.08); --shadow2:0 10px 22px rgba(31,35,40,.06);
      --radius:22px; --radius2:18px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",Arial,sans-serif;
      color:var(--ink);background:var(--bg);letter-spacing:.1px}
    .wrap{max-width:1120px;margin:0 auto;padding:28px 16px 56px}
    .hero{background:rgba(255,255,255,.78);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px 22px 18px}
    .heroTop{display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap}
    h1{margin:0;font-size:clamp(22px,2.5vw,34px);font-weight:900}
    .sub{margin-top:10px;color:var(--muted);line-height:1.7;font-size:14px;max-width:860px}
    .quoteRow{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
    .chip{border:1px solid var(--line);background:rgba(255,255,255,.75);border-radius:999px;padding:8px 12px;font-size:12px;color:rgba(31,35,40,.78)}
    .heroActions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-left:auto}
    button{font:inherit;cursor:pointer}
    .btn{border:1px solid var(--line);background:rgba(255,255,255,.85);padding:10px 12px;border-radius:14px;transition:transform .05s ease,background .15s ease,border-color .15s ease;
      display:inline-flex;align-items:center;gap:8px;user-select:none}
    .btn:hover{background:#fff;border-color:rgba(31,35,40,.16)} .btn:active{transform:translateY(1px)}
    .btn.primary{background:rgba(199,165,169,.18);border-color:rgba(199,165,169,.35)}
    .btn.sage{background:rgba(174,185,173,.20);border-color:rgba(174,185,173,.40)}
    .btn.danger{background:rgba(255,255,255,.85);border-color:rgba(170,70,70,.25);color:rgba(140,40,40,.95)}
    .grid{margin-top:18px;display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:980px){.grid{grid-template-columns:1.55fr 1fr}}
    .panel{background:rgba(255,255,255,.80);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow2);overflow:hidden}
    .panelHead{padding:16px 16px 12px;border-bottom:1px solid var(--line);display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .panelTitle{margin:0;font-size:16px;font-weight:900}
    .panelDesc{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.55}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{border:1px solid var(--line);background:rgba(255,255,255,.75);border-radius:999px;padding:7px 10px;font-size:12px;color:rgba(31,35,40,.78);cursor:pointer;user-select:none}
    .tab.active{background:rgba(141,151,161,.14);border-color:rgba(141,151,161,.35);color:rgba(31,35,40,.88)}
    .searchRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}
    .field{border:1px solid var(--line);background:rgba(255,255,255,.92);padding:10px 12px;border-radius:14px;outline:none;min-width:240px;flex:1}
    .field:focus{border-color:rgba(141,151,161,.55)}
    .content{padding:14px}
    .cards{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:640px){.cards{grid-template-columns:1fr 1fr}}
    .card{border:1px solid var(--line);background:rgba(255,255,255,.92);border-radius:var(--radius2);overflow:hidden;display:flex;flex-direction:column;min-height:290px}
    .thumb{height:150px;background:linear-gradient(135deg,rgba(199,165,169,.18),rgba(174,185,173,.16));position:relative;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb .thumbHint{position:absolute;inset:auto 10px 10px 10px;display:flex;justify-content:space-between;gap:8px;pointer-events:none}
    .pill{border:1px solid rgba(31,35,40,.10);background:rgba(255,255,255,.72);border-radius:999px;padding:6px 9px;font-size:12px;color:rgba(31,35,40,.78);
      backdrop-filter:blur(6px);max-width:100%;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    .cardBody{padding:12px 12px 14px;display:flex;flex-direction:column;gap:10px;flex:1}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .name{margin:0;font-weight:900;font-size:15px}
    .meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .badge,.price{font-size:12px;padding:5px 9px;border-radius:999px;border:1px solid rgba(31,35,40,.10);background:rgba(255,255,255,.72);color:rgba(31,35,40,.74)}
    .price{color:rgba(31,35,40,.78)}
    .note{width:100%;min-height:72px;resize:vertical;border:1px solid var(--line);background:rgba(255,255,255,.92);border-radius:14px;padding:10px 12px;outline:none;line-height:1.55;color:rgba(31,35,40,.88)}
    .note:focus{border-color:rgba(141,151,161,.55)}
    .btnRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:2px}
    .selectRow{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .toggle{display:flex;align-items:center;gap:8px;user-select:none;font-size:13px;color:rgba(31,35,40,.82)}
    input[type="checkbox"]{width:18px;height:18px;accent-color:var(--pink)}
    .summary{padding:14px;display:flex;flex-direction:column;gap:12px}
    .summaryBox{border:1px solid var(--line);background:rgba(255,255,255,.92);border-radius:var(--radius2);padding:12px}
    .summaryTitle{margin:0 0 6px;font-weight:900;font-size:14px}
    .summaryList{margin:0;padding-left:18px;color:rgba(31,35,40,.86);line-height:1.65;font-size:13px}
    .small{color:var(--muted);font-size:12px;line-height:1.6}
    .cta{padding:14px;border-top:1px solid var(--line);display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;background:rgba(255,255,255,.78)}
    .ctaMain{display:flex;flex-direction:column;gap:4px}
    .ctaBig{font-weight:900;font-size:14px}
    .btn.big{padding:12px 14px;border-radius:16px}
    .toast{position:fixed;right:16px;bottom:16px;width:min(380px,calc(100vw - 32px));background:rgba(255,255,255,.92);
      border:1px solid rgba(31,35,40,.10);border-radius:16px;box-shadow:var(--shadow);padding:12px;display:none;gap:8px;align-items:flex-start}
    .toast.show{display:flex} .toast b{font-size:13px}
    .toast .t{font-size:12px;color:var(--muted);line-height:1.6;margin-top:2px}
    .modal{position:fixed;inset:0;background:rgba(31,35,40,.55);display:none;align-items:center;justify-content:center;padding:18px;z-index:999}
    .modal.show{display:flex}
    .modalCard{width:min(720px,100%);border-radius:22px;background:rgba(255,255,255,.94);border:1px solid rgba(255,255,255,.20);
      box-shadow:0 24px 70px rgba(0,0,0,.25);overflow:hidden}
    .modalHead{padding:12px;border-bottom:1px solid rgba(31,35,40,.10);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .modalHead .title{font-weight:900;font-size:13px;color:rgba(31,35,40,.85);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;max-width:70%}
    .modalBody{padding:12px;display:flex;flex-direction:column;gap:10px}
    .formGrid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:560px){.formGrid{grid-template-columns:1fr 1fr}}
    .label{font-size:12px;color:rgba(31,35,40,.72);margin-bottom:6px}
    .control{display:flex;flex-direction:column;gap:6px}
    .select{border:1px solid var(--line);background:rgba(255,255,255,.92);padding:10px 12px;border-radius:14px;outline:none}
    .imgModalBody{padding:10px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.78)}
    .imgModalBody img{max-width:100%;max-height:78vh;border-radius:16px;display:block}
    footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:center;line-height:1.7;padding:10px 0}
  </style>
</head>

<body>
  <div class="wrap">
    <section class="hero">
      <div class="heroTop">
        <div>
          <h1>èƒ–æ¬£æ¬£ &amp; ç˜¦åª›åª›çš„ä¸“å±æƒ…äººèŠ‚</h1>
          <div class="sub">
            <div>â€œç˜¦åª›åª›è´Ÿè´£ç‚¹é¤ï¼Œèƒ–æ¬£æ¬£è´Ÿè´£æ¸…ç›˜ï¼ˆå’Œä¹°å•ï¼‰ã€‚â€</div>
            <div>â€œä»Šæ—¥èœå•ï¼šå”¯æœ‰çˆ±ä¸ç¾é£Ÿä¸å¯è¾œè´Ÿã€‚â€</div>
            <div>â€œç‚¹å‡»ç¡®è®¤ä¸‹å•ï¼Œçˆ±æƒ…å³åˆ»é€è¾¾ã€‚â€</div>
          </div>
          <div class="quoteRow">
            <span class="chip">ğŸ’¾ è‡ªåŠ¨ä¿å­˜ï¼ˆLocalStorageï¼‰</span>
            <span class="chip">ğŸ“· é«˜æ¸…åŸå›¾ IndexedDBï¼ˆä¸å¡ã€ä¸ä¸¢ï¼‰</span>
            <span class="chip">ğŸ“© ä¸‹å•é‚®ä»¶é€šçŸ¥ï¼ˆFormspreeï¼‰</span>
            <span class="chip">ğŸ§ æç®€è«å…°è¿ª + ç•™ç™½</span>
          </div>
        </div>

        <div class="heroActions">
          <button class="btn primary" id="btnAddDish">ï¼‹ æ–°å¢èœå“</button>
          <button class="btn sage" id="btnAddWish">ï¼‹ æ–°å¢å¿ƒæ„¿</button>
          <button class="btn" id="btnExport">å¯¼å‡º JSON</button>
          <button class="btn" id="btnImport">å¯¼å…¥ JSON</button>
          <button class="btn danger" id="btnReset">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </div>
      </div>
    </section>

    <div class="grid">
      <section class="panel">
        <div class="panelHead">
          <div>
            <h2 class="panelTitle">ä¸‰åˆä¸€èœå•ï¼ˆä¸­ / éŸ© / è¥¿ï¼‰</h2>
            <div class="panelDesc">å…± 50 é“é¢„è®¾èœå“ï¼›æ¯å¼ å¡æ”¯æŒç¼–è¾‘/åˆ é™¤/å‹¾é€‰ä¸‹å•/ä¸Šä¼ é«˜æ¸…å›¾ã€‚</div>

            <div class="tabs" id="tabs"></div>

            <div class="searchRow">
              <input class="field" id="search" placeholder="æœç´¢èœå / æ ‡ç­¾ï¼ˆæ¯”å¦‚ï¼šç‰›ã€è¾£ã€æ±¤ã€ç”œï¼‰" />
              <button class="btn" id="btnClearSearch">æ¸…ç©º</button>
            </div>
          </div>
        </div>

        <div class="content">
          <div class="cards" id="dishGrid"></div>
        </div>
      </section>

      <section class="panel">
        <div class="panelHead">
          <div>
            <h2 class="panelTitle">å¿ƒæ„¿æ¸…å•</h2>
            <div class="panelDesc">å†™ä¸‹æƒ³è¦çš„ç¤¼ç‰©/å°æ„¿æœ›ï¼Œå®æ—¶æ·»åŠ æˆå¡ç‰‡ã€‚</div>
          </div>
        </div>

        <div class="content">
          <div class="cards" id="wishGrid" style="grid-template-columns:1fr;"></div>
        </div>

        <div class="cta">
          <div class="ctaMain">
            <div class="ctaBig">ç¡®è®¤è®¢å•</div>
            <div class="small">ä¼šä¿å­˜åˆ°æœ¬åœ°ï¼Œå¹¶é€šè¿‡ Formspree å‘é€é‚®ä»¶é€šçŸ¥ã€‚</div>
          </div>
          <button class="btn primary big" id="btnConfirm">ç¡®è®¤ä¸‹å• Â· çˆ±æƒ…é€è¾¾</button>
        </div>

        <div class="summary">
          <div class="summaryBox">
            <p class="summaryTitle">å·²é€‰èœå•</p>
            <ol class="summaryList" id="selectedList"></ol>
            <div class="small" id="selectedEmpty">ï¼ˆè¿˜æ²¡é€‰èœï¼Œå…ˆç‚¹å‹¾é€‰ï½ï¼‰</div>
          </div>

          <div class="summaryBox">
            <p class="summaryTitle">å¿ƒæ„¿æ¸…å•</p>
            <ol class="summaryList" id="wishSummary"></ol>
            <div class="small" id="wishEmpty">ï¼ˆè¿˜æ²¡å†™å¿ƒæ„¿ï¼Œå¿«å†™ä¸€ä¸ªï½ï¼‰</div>
          </div>

          <div class="summaryBox">
            <p class="summaryTitle">é‚®ä»¶é€šçŸ¥è®¾ç½®</p>
            <div class="small">
              Formspree endpoint å·²ä¸ºä½ é¢„å¡«ï¼š<b>xpqjqdnd</b>ã€‚<br/>
              ä½ åªè¦åœ¨ Formspree åå°æŠŠæ¥æ”¶é‚®ç®±è®¾æˆä½ çš„é‚®ç®±å³å¯ã€‚
            </div>
            <div style="height:10px"></div>
            <input class="field" id="formspreeEndpoint" placeholder="Formspree Endpoint" />
            <div style="height:10px"></div>
            <input class="field" id="yourEmailHint" placeholder="ä½ çš„é‚®ç®±ï¼ˆä»…ä½œä¸ºè®¢å•å†…å®¹å­—æ®µï¼Œå¯ä¸å¡«ï¼‰" />
          </div>
        </div>
      </section>
    </div>

    <footer>
      GitHub Pagesï¼šæŠŠæœ¬æ–‡ä»¶å‘½åä¸º <b>index.html</b> æ”¾åˆ°ä»“åº“æ ¹ç›®å½• â†’ Settings â†’ Pages â†’ é€‰æ‹©åˆ†æ”¯éƒ¨ç½²ã€‚<br/>
      é«˜æ¸…åŸå›¾å­˜ IndexedDBï¼›ç¼©ç•¥å›¾/æ–‡æœ¬/é€‰æ‹©å­˜ LocalStorageã€‚
    </footer>
  </div>

  <div class="toast" id="toast">
    <div style="font-size:16px;line-height:1">âœ¨</div>
    <div>
      <b id="toastTitle">æç¤º</b>
      <div class="t" id="toastMsg"></div>
    </div>
  </div>

  <div class="modal" id="dishModal">
    <div class="modalCard">
      <div class="modalHead">
        <div class="title" id="dishModalTitle">æ–°å¢èœå“</div>
        <button class="btn" id="dishModalClose">å…³é—­</button>
      </div>
      <div class="modalBody">
        <div class="formGrid">
          <div class="control">
            <div class="label">èœå</div>
            <input class="field" id="dishName" placeholder="ä¾‹å¦‚ï¼šé»‘æ¤’ç‰›æ’" />
          </div>
          <div class="control">
            <div class="label">åˆ†ç±»</div>
            <select class="select" id="dishCuisine">
              <option value="ä¸­é¤">ä¸­é¤</option>
              <option value="éŸ©é¤">éŸ©é¤</option>
              <option value="è¥¿é¤">è¥¿é¤</option>
            </select>
          </div>
          <div class="control">
            <div class="label">æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰</div>
            <input class="field" id="dishTags" placeholder="ä¾‹å¦‚ï¼šå¾®è¾£/æš–èƒƒ/ç”œ" />
          </div>
          <div class="control">
            <div class="label">ä»·æ ¼ï¼ˆå¯é€‰ï¼‰</div>
            <input class="field" id="dishPrice" placeholder="ä¾‹å¦‚ï¼š58" inputmode="numeric" />
          </div>
        </div>
        <div class="control">
          <div class="label">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</div>
          <textarea class="note" id="dishNote" placeholder="ä¾‹å¦‚ï¼šç˜¦åª›åª›ç‚¹çš„ï¼Œèƒ–æ¬£æ¬£å¿…é¡»è¯´å¥½åƒ"></textarea>
        </div>

        <div class="btnRow">
          <button class="btn primary" id="dishSave">ä¿å­˜</button>
          <button class="btn" id="dishCancel">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="wishModal">
    <div class="modalCard">
      <div class="modalHead">
        <div class="title" id="wishModalTitle">æ–°å¢å¿ƒæ„¿</div>
        <button class="btn" id="wishModalClose">å…³é—­</button>
      </div>
      <div class="modalBody">
        <div class="control">
          <div class="label">å¿ƒæ„¿æ ‡é¢˜</div>
          <input class="field" id="wishTitleInput" placeholder="ä¾‹å¦‚ï¼šä¸€æŸå¥¶æ²¹ç™½ç«ç‘°" />
        </div>
        <div class="control">
          <div class="label">å¿ƒæ„¿æè¿°ï¼ˆå¯é€‰ï¼‰</div>
          <textarea class="note" id="wishDescInput" placeholder="ä¾‹å¦‚ï¼šä¸è¦å¤ªå¤¸å¼ ï¼Œè¦åƒä½ ä¸€æ ·é«˜çº§ã€‚"></textarea>
        </div>
        <div class="btnRow">
          <button class="btn primary" id="wishSave">ä¿å­˜</button>
          <button class="btn" id="wishCancel">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="imgModal">
    <div class="modalCard" style="width:min(980px,100%)">
      <div class="modalHead">
        <div class="title" id="imgModalTitle">é«˜æ¸…é¢„è§ˆ</div>
        <button class="btn" id="imgModalClose">å…³é—­</button>
      </div>
      <div class="imgModalBody">
        <img id="imgModalImg" alt="full" />
      </div>
    </div>
  </div>

  <script>
    // === Pre-fill Formspree endpoint (your provided) ===
    const DEFAULT_FORMSPREE_ENDPOINT = "https://formspree.io/f/xpqjqdnd";

    const LS_DISHES="pxxy_dishes_v3", LS_WISHES="pxxy_wishes_v3", LS_SETTINGS="pxxy_settings_v3", LS_ORDERS="pxxy_orders_v3";
    const DB_NAME="pxxy_images_db_v3", STORE="images";

    let dishes=[], wishes=[], filterCuisine="å…¨éƒ¨", searchQuery="";
    let editingDishId=null, editingWishId=null;

    const tabsEl=document.getElementById("tabs");
    const searchEl=document.getElementById("search");
    const dishGrid=document.getElementById("dishGrid");
    const wishGrid=document.getElementById("wishGrid");

    const selectedList=document.getElementById("selectedList");
    const selectedEmpty=document.getElementById("selectedEmpty");
    const wishSummary=document.getElementById("wishSummary");
    const wishEmpty=document.getElementById("wishEmpty");

    const endpointEl=document.getElementById("formspreeEndpoint");
    const emailHintEl=document.getElementById("yourEmailHint");

    const toast=document.getElementById("toast");
    const toastTitle=document.getElementById("toastTitle");
    const toastMsg=document.getElementById("toastMsg");
    let toastTimer=null;

    const dishModal=document.getElementById("dishModal");
    const dishModalTitle=document.getElementById("dishModalTitle");
    const dishName=document.getElementById("dishName");
    const dishCuisine=document.getElementById("dishCuisine");
    const dishTags=document.getElementById("dishTags");
    const dishPrice=document.getElementById("dishPrice");
    const dishNote=document.getElementById("dishNote");

    const wishModal=document.getElementById("wishModal");
    const wishModalTitle=document.getElementById("wishModalTitle");
    const wishTitleInput=document.getElementById("wishTitleInput");
    const wishDescInput=document.getElementById("wishDescInput");

    const imgModal=document.getElementById("imgModal");
    const imgModalTitle=document.getElementById("imgModalTitle");
    const imgModalImg=document.getElementById("imgModalImg");

    // Init
    loadAll();
    renderAll();

    document.getElementById("btnAddDish").addEventListener("click",()=>openDishModal(null));
    document.getElementById("btnAddWish").addEventListener("click",()=>openWishModal(null));

    document.getElementById("btnClearSearch").addEventListener("click",()=>{searchQuery="";searchEl.value="";renderAll();});
    searchEl.addEventListener("input",debounce(()=>{searchQuery=(searchEl.value||"").trim();renderAll();},120));

    const importFile=document.getElementById("importFile");
    document.getElementById("btnImport").addEventListener("click",()=>importFile.click());
    importFile.addEventListener("change",async()=>{
      const f=importFile.files&&importFile.files[0]; if(!f) return;
      try{
        const data=JSON.parse(await f.text());
        dishes=Array.isArray(data.dishes)?data.dishes:dishes;
        wishes=Array.isArray(data.wishes)?data.wishes:wishes;
        saveLS(LS_DISHES,dishes); saveLS(LS_WISHES,wishes);
        if(data.settings&&typeof data.settings==="object"){saveLS(LS_SETTINGS,data.settings);applySettingsFromLS();}
        renderAll(); showToast("å¯¼å…¥æˆåŠŸ","æ–‡æœ¬/é€‰æ‹©/ç¼©ç•¥å›¾å·²æ¢å¤ã€‚");
      }catch(e){showToast("å¯¼å…¥å¤±è´¥",e?.message||String(e));}
      finally{importFile.value="";}
    });

    document.getElementById("btnExport").addEventListener("click",()=>{
      const payload={version:3,exportedAt:Date.now(),dishes,wishes,settings:loadLS(LS_SETTINGS)||{},note:"åŸå›¾é«˜æ¸…å­˜ IndexedDBï¼Œä¸åœ¨ JSON å†…ï¼›JSON å†…åªåŒ…å«ç¼©ç•¥å›¾ dataURLã€‚"};
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download="èƒ–æ¬£æ¬£_ç˜¦åª›åª›_æƒ…äººèŠ‚_æ•°æ®.json";
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      showToast("å·²å¯¼å‡º","JSON å·²ä¸‹è½½ï¼ˆåŸå›¾ä¸åŒ…å«åœ¨å†…ï¼‰ã€‚");
    });

    document.getElementById("btnReset").addEventListener("click",async()=>{
      if(!confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿï¼ˆLocalStorage + IndexedDB å›¾ç‰‡ï¼‰"))return;
      localStorage.removeItem(LS_DISHES);localStorage.removeItem(LS_WISHES);localStorage.removeItem(LS_SETTINGS);localStorage.removeItem(LS_ORDERS);
      dishes=[];wishes=[];await idbClearAll();loadAll();renderAll();
      showToast("å·²æ¸…ç©º","å·²æ¢å¤åˆ°é»˜è®¤ 50 é“èœï¼ˆå›¾ç‰‡å·²æ¸…ç©ºï¼‰ã€‚");
    });

    endpointEl.addEventListener("input",debounce(saveSettings,200));
    emailHintEl.addEventListener("input",debounce(saveSettings,200));
    document.getElementById("btnConfirm").addEventListener("click",confirmOrder);

    document.getElementById("dishModalClose").addEventListener("click",closeDishModal);
    document.getElementById("dishCancel").addEventListener("click",closeDishModal);
    document.getElementById("dishSave").addEventListener("click",saveDishFromModal);
    dishModal.addEventListener("click",(e)=>{if(e.target===dishModal)closeDishModal();});

    document.getElementById("wishModalClose").addEventListener("click",closeWishModal);
    document.getElementById("wishCancel").addEventListener("click",closeWishModal);
    document.getElementById("wishSave").addEventListener("click",saveWishFromModal);
    wishModal.addEventListener("click",(e)=>{if(e.target===wishModal)closeWishModal();});

    document.getElementById("imgModalClose").addEventListener("click",closeImgModal);
    imgModal.addEventListener("click",(e)=>{if(e.target===imgModal)closeImgModal();});
    document.addEventListener("keydown",(e)=>{if(e.key==="Escape"){closeDishModal();closeWishModal();closeImgModal();}});

    function loadAll(){
      const lsD=loadLS(LS_DISHES);
      if(Array.isArray(lsD)&&lsD.length){dishes=lsD;}else{dishes=makePresetDishes50();saveLS(LS_DISHES,dishes);}
      const lsW=loadLS(LS_WISHES); wishes=Array.isArray(lsW)?lsW:[]; if(!Array.isArray(lsW))saveLS(LS_WISHES,wishes);
      applySettingsFromLS();
    }

    function applySettingsFromLS(){
      const s=loadLS(LS_SETTINGS)||{};
      endpointEl.value = s.formspreeEndpoint || DEFAULT_FORMSPREE_ENDPOINT;
      emailHintEl.value = s.yourEmailHint || "";
      // If user never saved settings before, persist the default endpoint once
      if (!s.formspreeEndpoint) saveSettings();
    }

    function saveSettings(){
      saveLS(LS_SETTINGS,{
        formspreeEndpoint:(endpointEl.value||"").trim() || DEFAULT_FORMSPREE_ENDPOINT,
        yourEmailHint:(emailHintEl.value||"").trim()
      });
    }

    function makePresetDishes50(){
      const base=[
        ["ä¸­é¤","çº¢çƒ§è‚‰","å®¶å¸¸/ä¸‹é¥­","58"],["ä¸­é¤","å®«ä¿é¸¡ä¸","å¾®è¾£/ç»å…¸","42"],["ä¸­é¤","æ°´ç…®ç‰›è‚‰","é‡è¾£/è¿‡ç˜¾","68"],
        ["ä¸­é¤","é…¸èœé±¼","é…¸çˆ½/æš–èƒƒ","66"],["ä¸­é¤","éº»å©†è±†è…","éº»è¾£/æ‹Œé¥­","32"],["ä¸­é¤","å°ç‚’é»„ç‰›è‚‰","é¦™è¾£/çˆ†ç‚’","62"],
        ["ä¸­é¤","ç³–é†‹é‡Œè„Š","é…¸ç”œ/å¼€èƒƒ","48"],["ä¸­é¤","è‘±çˆ†ç¾Šè‚‰","è‘±é¦™/ä¸‹é…’","72"],["ä¸­é¤","æ¸…è’¸é²ˆé±¼","æ¸…çˆ½/é²œ","78"],
        ["ä¸­é¤","è™¾ä»æ»‘è›‹","è½¯å«©/æ²»æ„ˆ","45"],["ä¸­é¤","ç•ªèŒ„ç‰›è…©","æµ“éƒ/æ±¤æ±","74"],["ä¸­é¤","çƒ¤é¸­å·","ä»ªå¼æ„Ÿ","88"],
        ["ä¸­é¤","è’œè“‰ç²‰ä¸è’¸æ‰‡è´","è’œé¦™/æµ·å‘³","76"],["ä¸­é¤","æ‹…æ‹…é¢","å¾®éº»/é¦™","28"],["ä¸­é¤","ç‰›è‚‰é¢ï¼ˆçº¢çƒ§ï¼‰","æš–èƒƒ/é¥±è¶³","32"],
        ["ä¸­é¤","é…¸è¾£æ±¤","å¼€èƒƒ/çƒ­ä¹","22"],["ä¸­é¤","è›‹ç‚’é¥­","ç»å…¸/ä¸è¸©é›·","18"],["ä¸­é¤","é”…åŒ…è‚‰","å¤–é…¥é‡Œå«©","52"],
        ["ä¸­é¤","æ¤’ç›æ’éª¨","é…¥é¦™/å’¸é¦™","58"],["ä¸­é¤","åŒçš®å¥¶","ç”œå“/æ¸©æŸ”","20"],

        ["éŸ©é¤","éƒ¨é˜Ÿé”…","æµ“éƒ/çƒ­è¾£","72"],["éŸ©é¤","æ³¡èœç‚’é¥­","é…¸è¾£/é¦™","36"],["éŸ©é¤","éŸ©å¼ç‚¸é¸¡","é…¥è„†/ç”œè¾£","56"],
        ["éŸ©é¤","çŸ³é”…æ‹Œé¥­","å‡è¡¡/æ»¡è¶³","48"],["éŸ©é¤","å‚é¸¡æ±¤","æ»‹è¡¥/æš–","88"],["éŸ©é¤","æµ·é²œè±†è…æ±¤","é²œè¾£/çƒ­ä¹","46"],
        ["éŸ©é¤","èŠå£«å¹´ç³•","æ‹‰ä¸/ç½ªæ¶","44"],["éŸ©é¤","çƒ¤äº”èŠ±è‚‰","é¦™/æ»¡è¶³","68"],["éŸ©é¤","çƒ¤ç‰›å°æ’","é«˜çº§/é¦™","98"],
        ["éŸ©é¤","å†·é¢","æ¸…çˆ½/è§£è…»","34"],["éŸ©é¤","è¾£ç‚’é±¿é±¼","é¦™è¾£/ä¸‹é¥­","58"],["éŸ©é¤","ç´«èœåŒ…é¥­","æ¸…çˆ½/æ–¹ä¾¿","28"],
        ["éŸ©é¤","æ³¡èœé¥¼","å¤–è„†/é…¸é¦™","32"],["éŸ©é¤","èœ‚èœœæŸšå­èŒ¶","æ¸…ç”œ","16"],["éŸ©é¤","è‰è“ç‰›å¥¶","ç”œç”œ","18"],

        ["è¥¿é¤","é»‘æ¤’ç‰›æ’","é«˜çº§/æ»¡è¶³","128"],["è¥¿é¤","å¥¶æ²¹è˜‘è‡æ„é¢","æ²»æ„ˆ/æ¸©æŸ”","68"],["è¥¿é¤","ç•ªèŒ„æµ·é²œæ„é¢","é²œ/é…¸ç”œ","76"],
        ["è¥¿é¤","å‡¯æ’’æ²™æ‹‰","æ¸…çˆ½/è½»ç›ˆ","42"],["è¥¿é¤","çƒ¤ä¸‰æ–‡é±¼","æ¸…çˆ½/é²œ","118"],["è¥¿é¤","çƒ¤é¸¡è…¿é…åœŸè±†","å®¶å¸¸/é¦™","88"],
        ["è¥¿é¤","è˜‘è‡æµ“æ±¤","æš–èƒƒ","36"],["è¥¿é¤","æ³•å¼æ´‹è‘±æ±¤","å±‚æ¬¡/é¦™","46"],["è¥¿é¤","èŠå£«æŠ«è¨","æ‹‰ä¸/å¿«ä¹","78"],
        ["è¥¿é¤","ç›æ ¼ä¸½ç‰¹æŠ«è¨","ç»å…¸","72"],["è¥¿é¤","ææ‹‰ç±³è‹","ç”œå“/æ°›å›´","38"],["è¥¿é¤","è‰è“å¥¶æ²¹è›‹ç³•","ç”œ/æµªæ¼«","42"],
        ["è¥¿é¤","ç„¦ç³–å¸ƒä¸","ä¸æ»‘","28"],["è¥¿é¤","æ— é…’ç²¾èµ·æ³¡é…’","ä»ªå¼æ„Ÿ","26"],["è¥¿é¤","çƒ­å¯å¯","æš–å¿ƒ","18"],
      ];
      return base.map(([cuisine,name,tags,price],idx)=>({
        id:crypto.randomUUID(),cuisine,name,tags,price,note:"",selected:false,thumbDataUrl:null,imageBlobKey:null,updatedAt:Date.now()-(base.length-idx)*1000
      }));
    }

    function renderAll(){ renderTabs(); renderDishes(); renderWishes(); renderSummary(); saveSettings(); }

    function renderTabs(){
      const all=dishes.length, cn=dishes.filter(d=>d.cuisine==="ä¸­é¤").length, kr=dishes.filter(d=>d.cuisine==="éŸ©é¤").length, we=dishes.filter(d=>d.cuisine==="è¥¿é¤").length;
      const tabs=[["å…¨éƒ¨",`å…¨éƒ¨ (${all})`],["ä¸­é¤",`ä¸­é¤ (${cn})`],["éŸ©é¤",`éŸ©é¤ (${kr})`],["è¥¿é¤",`è¥¿é¤ (${we})`]];
      tabsEl.innerHTML="";
      tabs.forEach(([key,label])=>{
        const t=document.createElement("div"); t.className="tab"+(filterCuisine===key?" active":""); t.textContent=label;
        t.addEventListener("click",()=>{filterCuisine=key;renderAll();}); tabsEl.appendChild(t);
      });
    }

    function renderDishes(){
      const q=searchQuery.toLowerCase();
      const list=dishes.filter(d=>{
        if(filterCuisine!=="å…¨éƒ¨"&&d.cuisine!==filterCuisine)return false;
        if(!q)return true;
        return (d.name+" "+(d.tags||"")+" "+(d.note||"")).toLowerCase().includes(q);
      });
      dishGrid.innerHTML="";
      if(!list.length){dishGrid.innerHTML=`<div class="small">æ²¡æœ‰åŒ¹é…ç»“æœï½</div>`;return;}
      for(const d of list) dishGrid.appendChild(renderDishCard(d));
    }

    function renderDishCard(d){
      const card=document.createElement("div"); card.className="card";
      const thumb=document.createElement("div"); thumb.className="thumb";
      const img=document.createElement("img"); img.loading="lazy"; img.decoding="async";
      if(d.thumbDataUrl){img.src=d.thumbDataUrl;} else {img.style.opacity="0";}
      thumb.appendChild(img);

      const hint=document.createElement("div"); hint.className="thumbHint";
      const p1=document.createElement("div"); p1.className="pill"; p1.textContent=d.thumbDataUrl?"ç‚¹æˆ‘çœ‹é«˜æ¸… / æ¢å›¾":"ä¸Šä¼ ç…§ç‰‡ï¼ˆé«˜æ¸…ï¼‰";
      const p2=document.createElement("div"); p2.className="pill"; p2.textContent=d.cuisine;
      hint.append(p1,p2); thumb.appendChild(hint);

      const body=document.createElement("div"); body.className="cardBody";
      const top=document.createElement("div"); top.className="row";
      const name=document.createElement("p"); name.className="name"; name.textContent=d.name;

      const meta=document.createElement("div"); meta.className="meta";
      const b1=document.createElement("span"); b1.className="badge"; b1.textContent=d.tags||"â€”";
      const b2=document.createElement("span"); b2.className="price"; b2.textContent=d.price?("Â¥ "+d.price):"Â¥ â€”";
      meta.append(b1,b2); top.append(name,meta);

      const note=document.createElement("textarea"); note.className="note";
      note.placeholder="å†™ç‚¹å¯çˆ±å¤‡æ³¨ï¼šä¸è¦é¦™èœ/è¦åŠ è¾£/ç˜¦åª›åª›è¯´è¿™é“å¿…é¡»ç‚¹â€¦";
      note.value=d.note||"";

      const selectRow=document.createElement("div"); selectRow.className="selectRow";
      const toggle=document.createElement("label"); toggle.className="toggle";
      const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=!!d.selected;
      const span=document.createElement("span"); span.textContent=d.selected?"å·²é€‰ä¸­ï¼ˆèƒ–æ¬£æ¬£å‡†å¤‡æ¸…ç›˜ï¼‰":"åŠ å…¥è®¢å•";
      toggle.append(cb,span);
      cb.addEventListener("change",()=>{d.selected=cb.checked;span.textContent=d.selected?"å·²é€‰ä¸­ï¼ˆèƒ–æ¬£æ¬£å‡†å¤‡æ¸…ç›˜ï¼‰":"åŠ å…¥è®¢å•";d.updatedAt=Date.now();saveLS(LS_DISHES,dishes);renderSummary();});
      selectRow.append(toggle);

      const btnRow=document.createElement("div"); btnRow.className="btnRow";
      const btnUpload=document.createElement("button"); btnUpload.className="btn primary"; btnUpload.textContent="ä¸Šä¼ /æ›´æ¢ç…§ç‰‡";
      const btnEdit=document.createElement("button"); btnEdit.className="btn"; btnEdit.textContent="ç¼–è¾‘";
      const btnDel=document.createElement("button"); btnDel.className="btn danger"; btnDel.textContent="åˆ é™¤";

      btnEdit.addEventListener("click",()=>openDishModal(d.id));
      btnDel.addEventListener("click",()=>{if(!confirm(`ç¡®å®šåˆ é™¤ã€Œ${d.name}ã€å—ï¼Ÿ`))return; dishes=dishes.filter(x=>x.id!==d.id); saveLS(LS_DISHES,dishes); renderAll(); showToast("å·²åˆ é™¤","è¿™é“èœè¢«åˆ’æ‰äº†ã€‚");});

      const fileInput=document.createElement("input"); fileInput.type="file"; fileInput.accept="image/*"; fileInput.style.display="none";
      btnUpload.addEventListener("click",()=>fileInput.click());

      fileInput.addEventListener("change",async()=>{
        const file=fileInput.files&&fileInput.files[0]; if(!file) return;
        const MAX_MB=15;
        if(file.size>MAX_MB*1024*1024){showToast("å›¾ç‰‡å¤ªå¤§",`è¶…è¿‡ ${MAX_MB}MBï¼Œå»ºè®®å‹ç¼©åå†ä¸Šä¼ ã€‚`); fileInput.value=""; return;}
        const blobKey=`dish:${d.id}:full`;
        await idbSet(blobKey,file);
        const thumbUrl=await makeThumbnailDataUrl(file,900,0.86);
        d.imageBlobKey=blobKey; d.thumbDataUrl=thumbUrl; d.updatedAt=Date.now();
        saveLS(LS_DISHES,dishes); renderDishes(); showToast("å·²ä¿å­˜å›¾ç‰‡","åŸå›¾å·²å­˜ IndexedDBã€‚");
        fileInput.value="";
      });

      note.addEventListener("input",debounce(()=>{d.note=note.value;d.updatedAt=Date.now();saveLS(LS_DISHES,dishes);renderSummary();},220));

      thumb.addEventListener("click",async()=>{ if(!d.imageBlobKey){fileInput.click();return;} await showFullImage(d.imageBlobKey,`${d.cuisine} Â· ${d.name}`); });

      btnRow.append(btnUpload,btnEdit,btnDel);
      body.append(top,note,selectRow,btnRow);
      card.append(thumb,body,fileInput);
      return card;
    }

    function renderWishes(){
      wishGrid.innerHTML="";
      if(!wishes.length){wishGrid.innerHTML=`<div class="small">è¿˜æ²¡æœ‰å¿ƒæ„¿ï½ ç‚¹å³ä¸Šè§’ã€Œæ–°å¢å¿ƒæ„¿ã€å†™ä¸€ä¸ªå§ã€‚</div>`;return;}
      for(const w of wishes) wishGrid.appendChild(renderWishCard(w));
    }

    function renderWishCard(w){
      const card=document.createElement("div"); card.className="card"; card.style.minHeight="260px";
      const thumb=document.createElement("div"); thumb.className="thumb";
      const img=document.createElement("img"); img.loading="lazy"; img.decoding="async";
      if(w.thumbDataUrl){img.src=w.thumbDataUrl;} else {img.style.opacity="0";}
      thumb.appendChild(img);

      const hint=document.createElement("div"); hint.className="thumbHint";
      const p1=document.createElement("div"); p1.className="pill"; p1.textContent=w.thumbDataUrl?"ç‚¹æˆ‘çœ‹é«˜æ¸… / æ¢å›¾":"ç»™å¿ƒæ„¿é…å¼ å›¾ï¼ˆé«˜æ¸…ï¼‰";
      const p2=document.createElement("div"); p2.className="pill"; p2.textContent="Wishlist";
      hint.append(p1,p2); thumb.appendChild(hint);

      const body=document.createElement("div"); body.className="cardBody";
      const top=document.createElement("div"); top.className="row";
      const name=document.createElement("p"); name.className="name"; name.textContent=w.title;
      const meta=document.createElement("div"); meta.className="meta";
      const b=document.createElement("span"); b.className="badge"; b.textContent="å¿ƒæ„¿"; meta.append(b);
      top.append(name,meta);

      const note=document.createElement("textarea"); note.className="note";
      note.placeholder="å†™ç‚¹æè¿°ï¼šé¢œè‰²/é¢„ç®—/æƒ³è¦çš„æ„Ÿè§‰â€¦";
      note.value=w.desc||"";

      const btnRow=document.createElement("div"); btnRow.className="btnRow";
      const btnUpload=document.createElement("button"); btnUpload.className="btn primary"; btnUpload.textContent="ä¸Šä¼ /æ›´æ¢ç…§ç‰‡";
      const btnEdit=document.createElement("button"); btnEdit.className="btn"; btnEdit.textContent="ç¼–è¾‘";
      const btnDel=document.createElement("button"); btnDel.className="btn danger"; btnDel.textContent="åˆ é™¤";

      btnEdit.addEventListener("click",()=>openWishModal(w.id));
      btnDel.addEventListener("click",()=>{if(!confirm(`ç¡®å®šåˆ é™¤å¿ƒæ„¿ã€Œ${w.title}ã€å—ï¼Ÿ`))return; wishes=wishes.filter(x=>x.id!==w.id); saveLS(LS_WISHES,wishes); renderAll(); showToast("å·²åˆ é™¤","å¿ƒæ„¿æ”¶è¿›æŠ½å±‰é‡Œã€‚");});

      const fileInput=document.createElement("input"); fileInput.type="file"; fileInput.accept="image/*"; fileInput.style.display="none";
      btnUpload.addEventListener("click",()=>fileInput.click());

      fileInput.addEventListener("change",async()=>{
        const file=fileInput.files&&fileInput.files[0]; if(!file) return;
        const MAX_MB=15;
        if(file.size>MAX_MB*1024*1024){showToast("å›¾ç‰‡å¤ªå¤§",`è¶…è¿‡ ${MAX_MB}MBï¼Œå»ºè®®å‹ç¼©åå†ä¸Šä¼ ã€‚`); fileInput.value=""; return;}
        const blobKey=`wish:${w.id}:full`;
        await idbSet(blobKey,file);
        const thumbUrl=await makeThumbnailDataUrl(file,900,0.86);
        w.imageBlobKey=blobKey; w.thumbDataUrl=thumbUrl; w.updatedAt=Date.now();
        saveLS(LS_WISHES,wishes); renderWishes(); renderSummary(); showToast("å·²ä¿å­˜å›¾ç‰‡","åŸå›¾å·²å­˜ IndexedDBã€‚");
        fileInput.value="";
      });

      note.addEventListener("input",debounce(()=>{w.desc=note.value;w.updatedAt=Date.now();saveLS(LS_WISHES,wishes);renderSummary();},220));
      thumb.addEventListener("click",async()=>{ if(!w.imageBlobKey){fileInput.click();return;} await showFullImage(w.imageBlobKey,`å¿ƒæ„¿ Â· ${w.title}`); });

      btnRow.append(btnUpload,btnEdit,btnDel);
      body.append(top,note,btnRow);
      card.append(thumb,body,fileInput);
      return card;
    }

    function renderSummary(){
      const selected=dishes.filter(d=>d.selected);
      selectedList.innerHTML="";
      selectedEmpty.style.display=selected.length?"none":"block";
      selected.forEach(d=>{
        const li=document.createElement("li");
        li.textContent=`${d.cuisine}ï½œ${d.name}${d.price?`ï¼ˆÂ¥${d.price}ï¼‰`:""}`;
        selectedList.appendChild(li);
      });

      wishSummary.innerHTML="";
      wishEmpty.style.display=wishes.length?"none":"block";
      wishes.forEach(w=>{
        const li=document.createElement("li"); li.textContent=w.title; wishSummary.appendChild(li);
      });
    }

    // Modals: Dish
    function openDishModal(id){
      editingDishId=id;
      if(!id){
        dishModalTitle.textContent="æ–°å¢èœå“";
        dishName.value=""; dishCuisine.value="ä¸­é¤"; dishTags.value=""; dishPrice.value=""; dishNote.value="";
      }else{
        const d=dishes.find(x=>x.id===id); if(!d) return;
        dishModalTitle.textContent="ç¼–è¾‘èœå“";
        dishName.value=d.name||""; dishCuisine.value=d.cuisine||"ä¸­é¤"; dishTags.value=d.tags||""; dishPrice.value=d.price||""; dishNote.value=d.note||"";
      }
      dishModal.classList.add("show"); setTimeout(()=>dishName.focus(),0);
    }
    function closeDishModal(){ dishModal.classList.remove("show"); editingDishId=null; }
    function saveDishFromModal(){
      const name=(dishName.value||"").trim();
      const cuisine=(dishCuisine.value||"").trim();
      const tags=(dishTags.value||"").trim();
      const price=(dishPrice.value||"").trim();
      const note=(dishNote.value||"").trim();
      if(!name){showToast("ç¼ºå°‘èœå","è¯·å…ˆè¾“å…¥èœåï½"); dishName.focus(); return;}
      if(!editingDishId){
        dishes.unshift({id:crypto.randomUUID(),cuisine:cuisine||"ä¸­é¤",name,tags,price,note,selected:false,thumbDataUrl:null,imageBlobKey:null,updatedAt:Date.now()});
        saveLS(LS_DISHES,dishes); renderAll(); closeDishModal(); showToast("å·²æ–°å¢","æ–°èœä¸Šçº¿âœ…");
      }else{
        const d=dishes.find(x=>x.id===editingDishId); if(!d) return;
        d.name=name; d.cuisine=cuisine||d.cuisine; d.tags=tags; d.price=price; d.note=note; d.updatedAt=Date.now();
        saveLS(LS_DISHES,dishes); renderAll(); closeDishModal(); showToast("å·²ä¿å­˜","ç¼–è¾‘å®Œæˆã€‚");
      }
    }

    // Modals: Wish
    function openWishModal(id){
      editingWishId=id;
      if(!id){
        wishModalTitle.textContent="æ–°å¢å¿ƒæ„¿";
        wishTitleInput.value=""; wishDescInput.value="";
      }else{
        const w=wishes.find(x=>x.id===id); if(!w) return;
        wishModalTitle.textContent="ç¼–è¾‘å¿ƒæ„¿";
        wishTitleInput.value=w.title||""; wishDescInput.value=w.desc||"";
      }
      wishModal.classList.add("show"); setTimeout(()=>wishTitleInput.focus(),0);
    }
    function closeWishModal(){ wishModal.classList.remove("show"); editingWishId=null; }
    function saveWishFromModal(){
      const title=(wishTitleInput.value||"").trim();
      const desc=(wishDescInput.value||"").trim();
      if(!title){showToast("ç¼ºå°‘å¿ƒæ„¿æ ‡é¢˜","å…ˆå†™ä¸€å¥ä½ æƒ³è¦çš„ï½"); wishTitleInput.focus(); return;}
      if(!editingWishId){
        wishes.unshift({id:crypto.randomUUID(),title,desc,thumbDataUrl:null,imageBlobKey:null,updatedAt:Date.now()});
        saveLS(LS_WISHES,wishes); renderAll(); closeWishModal(); showToast("å¿ƒæ„¿å·²åŠ å…¥","èƒ–æ¬£æ¬£ï¼šæ”¶åˆ°ï¼");
      }else{
        const w=wishes.find(x=>x.id===editingWishId); if(!w) return;
        w.title=title; w.desc=desc; w.updatedAt=Date.now();
        saveLS(LS_WISHES,wishes); renderAll(); closeWishModal(); showToast("å·²ä¿å­˜","å¿ƒæ„¿æ›´æ–°å®Œæˆã€‚");
      }
    }

    // Confirm order
    async function confirmOrder(){
      const selected=dishes.filter(d=>d.selected);
      if(!selected.length && !wishes.length){showToast("è¿˜ä¸èƒ½ä¸‹å•","è‡³å°‘é€‰ä¸€é“èœæˆ–å†™ä¸€ä¸ªå¿ƒæ„¿ï½"); return;}

      const now=new Date();
      const order={
        id:crypto.randomUUID(),
        createdAt:now.toISOString(),
        createdAtLocal:now.toLocaleString(),
        title:"èƒ–æ¬£æ¬£ & ç˜¦åª›åª›çš„ä¸“å±æƒ…äººèŠ‚",
        selectedDishes:selected.map(d=>({cuisine:d.cuisine,name:d.name,price:d.price||"",tags:d.tags||"",note:d.note||""})),
        wishes:wishes.map(w=>({title:w.title,desc:w.desc||""})),
        yourEmailHint:(emailHintEl.value||"").trim()
      };

      const history=loadLS(LS_ORDERS)||[];
      history.unshift(order);
      saveLS(LS_ORDERS,history);

      const endpoint=(endpointEl.value||"").trim() || DEFAULT_FORMSPREE_ENDPOINT;
      if(!endpoint){showToast("å·²ä¿å­˜åˆ°æœ¬åœ° âœ…","æœªå¡«å†™ endpointï¼Œå› æ­¤æœªå‘é€é‚®ä»¶ã€‚"); return;}

      showToast("æ­£åœ¨å‘é€é‚®ä»¶â€¦","å¦‚æœå¤±è´¥ä¹Ÿæ²¡äº‹ï¼šè®¢å•å·²ç»æœ¬åœ°ä¿å­˜ã€‚");
      try{
        const text=buildOrderEmailText(order);
        const resp=await fetch(endpoint,{
          method:"POST",
          headers:{"Content-Type":"application/json","Accept":"application/json"},
          body:JSON.stringify({
            subject:"ğŸ’Œ æƒ…äººèŠ‚ä¸‹å•é€šçŸ¥ï½œèƒ–æ¬£æ¬£ & ç˜¦åª›åª›",
            message:text,
            your_email:order.yourEmailHint||"",
            created_at:order.createdAtLocal
          })
        });
        if(!resp.ok){
          const t=await safeReadText(resp);
          throw new Error(`å‘é€å¤±è´¥ï¼šHTTP ${resp.status} ${resp.statusText}${t?(" / "+t):""}`);
        }
        showToast("å‘é€æˆåŠŸ âœ…","é‚®ä»¶å·²å‘å‡ºï¼šèƒ–æ¬£æ¬£æ”¶åˆ°è®¢å•ï¼Œå‡†å¤‡ä¸Šèœï¼ˆå’Œä¹°å•ï¼‰ã€‚");
      }catch(e){
        showToast("é‚®ä»¶å‘é€å¤±è´¥",(e?.message||String(e))+"ï¼ˆä½†è®¢å•å·²ä¿å­˜åˆ°æœ¬åœ°ï¼‰");
      }
    }

    function buildOrderEmailText(order){
      const lines=[];
      lines.push("èƒ–æ¬£æ¬£ & ç˜¦åª›åª›çš„ä¸“å±æƒ…äººèŠ‚ï½œä¸‹å•é€šçŸ¥");
      lines.push("â€”");
      lines.push(`ä¸‹å•æ—¶é—´ï¼š${order.createdAtLocal}`);
      if(order.yourEmailHint) lines.push(`ä¸‹å•äººé‚®ç®±(å¤‡æ³¨)ï¼š${order.yourEmailHint}`);
      lines.push("");

      lines.push("å·²é€‰èœå•ï¼š");
      if(order.selectedDishes.length){
        order.selectedDishes.forEach((d,i)=>{
          lines.push(`${i+1}. ${d.cuisine}ï½œ${d.name}${d.price?`ï¼ˆÂ¥${d.price}ï¼‰`:""}${d.tags?`ï½œ${d.tags}`:""}`);
          if(d.note) lines.push(`   å¤‡æ³¨ï¼š${d.note}`);
        });
      }else lines.push("ï¼ˆæœªé€‰æ‹©èœå“ï¼‰");

      lines.push("");
      lines.push("å¿ƒæ„¿æ¸…å•ï¼š");
      if(order.wishes.length){
        order.wishes.forEach((w,i)=>{
          lines.push(`${i+1}. ${w.title}`);
          if(w.desc) lines.push(`   æè¿°ï¼š${w.desc}`);
        });
      }else lines.push("ï¼ˆæ— å¿ƒæ„¿ï¼‰");

      lines.push("");
      lines.push("ä¿çš®å¤‡æ³¨ï¼š");
      lines.push("â€œç˜¦åª›åª›è´Ÿè´£ç‚¹é¤ï¼Œèƒ–æ¬£æ¬£è´Ÿè´£æ¸…ç›˜ï¼ˆå’Œä¹°å•ï¼‰ã€‚â€");
      lines.push("â€œç‚¹å‡»ç¡®è®¤ä¸‹å•ï¼Œçˆ±æƒ…å³åˆ»é€è¾¾ã€‚â€");
      return lines.join("\n");
    }

    async function safeReadText(resp){ try{ return (await resp.text()).slice(0,200);}catch{return"";} }

    function showToast(title,msg){
      toastTitle.textContent=title; toastMsg.textContent=msg;
      toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer=setTimeout(()=>toast.classList.remove("show"),4200);
    }

    function loadLS(key){ try{const raw=localStorage.getItem(key); return raw?JSON.parse(raw):null;}catch{return null;} }
    function saveLS(key,val){ localStorage.setItem(key,JSON.stringify(val)); }

    function debounce(fn,waitMs){ let t=null; return (...args)=>{clearTimeout(t); t=setTimeout(()=>fn(...args),waitMs);} }

    // IndexedDB
    function openDB(){
      return new Promise((resolve,reject)=>{
        const req=indexedDB.open(DB_NAME,1);
        req.onupgradeneeded=()=>{const db=req.result; if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);};
        req.onsuccess=()=>resolve(req.result);
        req.onerror=()=>reject(req.error);
      });
    }
    async function idbSet(key,blob){
      const db=await openDB();
      return new Promise((resolve,reject)=>{
        const tx=db.transaction(STORE,"readwrite");
        tx.objectStore(STORE).put(blob,key);
        tx.oncomplete=()=>resolve(true);
        tx.onerror=()=>reject(tx.error);
      });
    }
    async function idbGet(key){
      const db=await openDB();
      return new Promise((resolve,reject)=>{
        const tx=db.transaction(STORE,"readonly");
        const req=tx.objectStore(STORE).get(key);
        req.onsuccess=()=>resolve(req.result||null);
        req.onerror=()=>reject(req.error);
      });
    }
    async function idbClearAll(){
      const db=await openDB();
      return new Promise((resolve,reject)=>{
        const tx=db.transaction(STORE,"readwrite");
        tx.objectStore(STORE).clear();
        tx.oncomplete=()=>resolve(true);
        tx.onerror=()=>reject(tx.error);
      });
    }

    async function makeThumbnailDataUrl(file,maxW=900,quality=0.86){
      const bmp=await createImageBitmap(file);
      const scale=Math.min(1,maxW/bmp.width);
      const w=Math.max(1,Math.round(bmp.width*scale));
      const h=Math.max(1,Math.round(bmp.height*scale));
      const canvas=document.createElement("canvas"); canvas.width=w; canvas.height=h;
      const ctx=canvas.getContext("2d",{alpha:false});
      ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality="high";
      ctx.drawImage(bmp,0,0,w,h);
      let type="image/webp";
      let url=canvas.toDataURL(type,quality);
      if(!url.startsWith("data:image/webp")){
        type="image/jpeg";
        url=canvas.toDataURL(type,quality);
      }
      return url;
    }

    async function showFullImage(blobKey,title){
      const blob=await idbGet(blobKey);
      if(!blob){showToast("æ‰¾ä¸åˆ°åŸå›¾","å¯èƒ½è¢«æµè§ˆå™¨æ¸…ç†è¿‡ï¼Œè¯·é‡æ–°ä¸Šä¼ ã€‚");return;}
      const url=URL.createObjectURL(blob);
      imgModalTitle.textContent=title||"é«˜æ¸…é¢„è§ˆ";
      imgModalImg.src=url;
      imgModal.dataset.url=url;
      imgModal.classList.add("show");
    }
    function closeImgModal(){
      imgModal.classList.remove("show");
      const url=imgModal.dataset.url;
      if(url) URL.revokeObjectURL(url);
      imgModal.dataset.url="";
      imgModalImg.src="";
    }
  </script>
</body>
</html>
